{
    "args": [
        
    ],
    "provider": "EntraID",
    "serviceType": "Conditional Access",
    "serviceName": "Microsoft Entra ID",
    "displayName": "Enable Identity Protection sign-in risk policies",
    "description": "\r\n\t\tMicrosoft Entra ID Protection sign-in risk detects risks in real-time and offline. A risky sign-in is an indicator for a sign-in attempt that might not have been performed by the legitimate owner of a user account. \r\n\t\t**Note** : While Identity Protection also provides two risk policies with limited conditions, Microsoft highly recommends setting up risk-based policies in Conditional Access as opposed to the `legacy method` for the following benefits: \r\n\t\t* Enhanced diagnostic data \r\n\t\t* Report-only mode integration \r\n\t\t* Graph API support \r\n\t\t* Use more Conditional Access attributes like sign-in frequency in the policy\r\n  ",
    "rationale": "Turning on the sign-in risk policy ensures that suspicious sign-ins are challenged for multi-factor authentication.",
    "impact": "When the policy triggers, the user will need MFA to access the account. In the case of a user who hasn\u0027t registered MFA on their account, they would be blocked from accessing their account. It is therefore recommended that the MFA registration policy be configured for all users who are a part of the Sign-in Risk policy.",
    "remediation": {
        "text": "###### From Azure Console\r\n\t\t\t\t\t1. From Azure Home open the Portal Menu in top left, and select Microsoft Entra ID\r\n\t\t\t\t\t2. Scroll down in the menu on the left, and select `Security`\r\n\t\t\t\t\t3. Select on the left side `Conditional Access`\r\n\t\t\t\t\t4. Click the `+ New policy`",
        "code": {
            "powerShell": null,
            "iac": null,
            "terraform": null,
            "other": null
        }
    },
    "recommendation": null,
    "references": [
        "https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/howto-identity-protection-risk-feedback",
        "https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks"
    ],
    "compliance": [
        {
            "name": "CIS Microsoft 365 Foundations Benchmark",
            "version": "5.0.0",
            "reference": "5.2.2.7",
            "profile": "E3 Level 2"
        }
    ],
    "level": "medium",
    "tags": [
        
    ],
    "rule": {
        "path": "aad_conditional_access_policy",
        "subPath": null,
        "selectCondition": {
            
        },
        "query": [
            {
                "filter": [
                    {
                        "conditions": [
                            [
                                "state",
                                "eq",
                                "enabled"
                            ],
							[
                                "conditions.users.includeUsers",
                                "eq",
                                "All"
                            ],
                            [
                                "conditions.applications.includeApplications",
                                "eq",
                                "All"
                            ]
                        ],
                        "operator": "and"
                    }
                ]
            },
			{
                "connectOperator": "and",
                "filter": [
                    {
                        "conditions": [
                            [
								"MicrosoftAdminPortals",
                                "notin",
                                "conditions.applications.excludeApplications"
                            ],
                            [
								"Office365",
                                "notin",
                                "conditions.applications.excludeApplications"
                            ]
                        ],
                        "operator": "or"
                    }
                ]
            },
			{
                "connectOperator": "and",
                "filter": [
                    {
                        "include": "_ARG_0_"
                    }
                ]
            },
            {
                "connectOperator": "and",
                "filter": [
                    {
                        "conditions": [
                            [
                                "grantControls.operator",
                                "eq",
                                "OR"
                            ],
                            [
                                "grantControls.builtInControls",
                                "match",
                                "mfa"
                            ]
                        ],
                        "operator": "and"
                    }
                ]
            },
			{
                "connectOperator": "and",
                "filter": [
                    {
                        "conditions": [
                            [
                                "sessionControls.signInFrequency.isEnabled",
                                "eq",
                                "true"
                            ],
							[
                                "sessionControls.signInFrequency.frequencyInterval",
                                "eq",
                                "everyTime"
                            ]
                        ],
                        "operator": "and"
                    }
                ]
            }
        ],
        "shouldExist": "true",
        "returnObject": null,
        "removeIfNotExists": null
    },
    "output": {
        "html": {
            "data": {
                "properties": {
                    "displayName": "Name",
                    "state": "Status",
                    "conditions.applications.includeApplications": "Applications",
                    "conditions.users.includeUsers": "Users",
                    "conditions.userRiskLevels": "User Risk Levels",
                    "grantControls.operator": "Operator",
                    "grantControls.builtInControls": "BuiltIn Controls"
                },
                "expandObject": null
            },
            "table": null,
            "decorate": [
                
            ],
            "emphasis": [
                
            ],
            "actions": {
                "objectData": {
                    "properties": [
                        "*"
                    ],
                    "expandObject": null,
                    "limit": null
                },
                "showGoToButton": false,
                "showModalButton": false,
                "directLink": null
            }
        },
        "text": {
            "data": {
                "properties": {
                    "displayName": "Name",
                    "state": "Status",
                    "conditions.applications.includeApplications": "Applications",
                    "conditions.users.includeUsers": "Users",
                    "conditions.userRiskLevels": "User Risk Levels",
                    "grantControls.operator": "Operator",
                    "grantControls.builtInControls": "BuiltIn Controls"
                },
                "expandObject": null
            },
            "status": {
                "keyName": [
                    
                ],
                "message": "Enable Entra ID Identity Protection sign-in risk policies",
                "defaultMessage": null
            },
            "properties": {
                "resourceName": "displayName",
                "resourceId": "id",
                "resourceType": "EntraConditionalAccess"
            },
            "onlyStatus": true
        }
    },
    "idSuffix": "aad_cap_sign_in_risk_policy",
    "notes": [
        
    ],
    "categories": [
        
    ],
    "immutable_properties": [
		"id"
    ],
    "id": "entraid_1118"
}
